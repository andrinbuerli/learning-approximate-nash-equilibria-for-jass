version: '3.8'
services:
    trainer:
        build: .
        volumes:
            - .:/app
        ports:
          - 8080:8080
        command: >
            bash -c "cd scripts && python train_mu_zero.py
            --log"
        deploy:
          resources:
            reservations:
              devices:
                - driver: nvidia
                  device_ids: ['0']
                  capabilities: [gpu]

    evaluate_agents:
        build: .
        volumes:
            - .:/app
        command: >
            bash -c "cd scripts/evaluation && python evaluate_agents.py
            --max_parallel_processes 8,
            --skip_on_result_file True,
            --use_python True,
            --file imperfect_info_evaluate_agents.json"
        deploy:
          resources:
            reservations:
              devices:
                - driver: nvidia
                  device_ids: ['0']
                  capabilities: [gpu]

    baselines:
        build: .
        ports:
          - 9898:9898
          - 9897:9897
          - 9896:9896
        volumes:
            - .:/app
        command: bash -c "
                  cd scripts
                  && python host_agents.py --files dmcts.json dpolicy.json random.json"

    test:
        build:
            context: .
            args:
                DEV: 1
        ports:
          - 8080:8080
        entrypoint: []
        volumes:
            - .:/app
        command: pytest --forked -n auto --timeout=120 /app/test -v


